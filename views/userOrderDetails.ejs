<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&family=Rubik:wght@300;400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/userOrderDetails.css" />
 
    <title>User Order Details</title>
  </head>
  <body>
    <div class="container nav-container">
      <div class="nav-main">
        <h2 class="navmain-heading">VRNA</h2>
        <h5>SHOP</h5>
        <h5>CONTACT</h5>
        <h5>ABOUT</h5>
      </div>
      <div class="nav-sec">
        <h5><ion-icon name="search-outline"></ion-icon> </h5>
        <h5><ion-icon name="person-outline"></ion-icon></h5>
        <h5><ion-icon name="cart-outline"></ion-icon></h5>
        </div>
    </h5>
    </div>
    <h2 class="primary-heading">Order Details</h2>
    <span id="span" class=" d-flex align-content-end"></span>
    <div class="container outerContainer">
   
     
          <div class="container text-center cardContainer">
            <table class="table caption-top">
              <div class="addcontainer">
              
           
               
              </div>
              <thead >
                <tr>
                  <th scope="col">S.NO</th>
                  <th scope="col">DATE</th>
                  <th scope="col">PAYMENT MODE</th>
                  <th scope="col">STATUS</th>
                  <th scope="col">PRODUCT NAME</th>
                  <th scope="col">PRICE</th>
          
                  <th scope="col"> INVOICE</th>
         
                  <th scope="col">REMOVE</th>
                  
                  <th></th>
                </tr>
              </thead>
              <tbody id="productTableBody">
                <% let num = number ;%>  <% orders.forEach((order) =>{ %>
                  
                <tr>
                  <td scope="row"><a class="details_link" href="/user/orderdetails/<%=order._id%>"><%=num%></a></td>
                  <td>
                            <%= order.Date %>
                  </td>
                  <td><%=order.paymentMode %></td>
                  <td id="<%=order._id%>"><%=order.OrderedState %></td>
                  <td>
                    <% order.productsInfo.forEach((info)=>{%>
                    <ul>
                      <li class="d-inline"><%=(info.productName).toLowerCase()%></li>
                    </ul>
                    <% })%>
                  </td>
                  <td><%=order.totalPrice%></td>
                  <td>
                    <button class="btn btn-danger btns invoice_btn " data-invoice-id="<%= order._id %>">
                      DOWNLOAD
                    </button>
                    
                    <!-- <a href="/user/invoice/<%=order._id%>">fgrthrftyftgrth</a> -->
                  </td>
                  <td id="td<%= order._id %>" class="tdbtn">
                    <% if (   order.OrderedState !== "delivered" &&
                    order.OrderedState !== "Applied For Return" &&
                    order.OrderedState !== "Accepted" &&
                    order.OrderedState !== "Rejected"&&  order.OrderedState !== "cancelled") { %>
                      <button class="btn btn-danger btns cance_btn" data-order-id="<%= order._id %>" data-user-id="<%= order.userId %>">
                        CANCEL
                      </button>
                    <% } %>
                  </td>
                
              
                </tr>
                <% num = num+1%>  <% }) %>
              </tbody>
               
            </table>
            <div id="pagination">
              <ul class="pagination">
                <% if (currentPage > 1) { %>
                  <li class="page-item"><a  class="page-link" href="/user/userOrderDetails?page=<%= currentPage - 1 %>">Previous</a></li>
                <% } %>
            
                <% for (let i = 1; i <= totalPages; i++) { %>
                  <li <% if (currentPage === i) { %>class="active page-item"<% } %>>
                    <a class="page-link"  href="/user/userOrderDetails?page=<%= i %>"><%= i %></a>
                  </li>
                <% } %>
            
                <% if (currentPage < totalPages) { %>
                  <li class="page-item"><a  class="page-link" href="/user/userOrderDetails?page=<%= currentPage + 1 %>">Next</a></li>
                <% } %>
              </ul>
            </div>
            <a href="/user/" class="btn btn-Buynow">BACK TO SHOPPING</a>
            </div>
           </div>  

    <footer>
      <div class="text-center footer-container">
        <div class="container">
          <div class="container row">
            <div class="col">
              <ul class="footerul">
                <li><h1 class="heading-footer footer-link">VRNA</h1></li>
                <li class="footer-link">
                  <p>
                    Workout Clothes designed to help you become your personal
                    best. Because when it comes to performing at your max, there
                    should be no obstacles – least of all your workout clothes.
                  </p>
                </li>
              </ul>
            </div>
            <div class="col">
              <ul class="footerul">
                <li><a class="footer-link" href="#">SHOPPING</a></li>
                <li><a class="footer-link" href="#">SALES</a></li>
              </ul>
            </div>
            <div class="col">
              <ul class="footerul">
                <li><a class="footer-link" href="#">SHOPPING</a></li>
                <li><a class="footer-link" href="#">Contact Us</a></li>
                <li><a class="footer-link" href="#">Payment Method</a></li>
                <li><a class="footer-link" href="#">Delivery</a></li>
              </ul>
            </div>
            <div class="col">
              <ul class="footerul">
                <li><a class="footer-link" href="#">NEWSLETTER</a></li>
                <li class="footer-link">
                  <p>
                    Be the first to know about new arrivals, look books, sales &
                    promos
                  </p>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <br />
        <p class="copyright">Copyright © 3333 All rights reserved | VRNA</p>
      </div>
    
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

//   function generatePaginationLinks(currentPage, totalPages, query) {
//   let paginationHTML = `<ul class="pagination">`;

//   if (currentPage > 1) {
//     paginationHTML += `<li class="page-item"><a class="page-link" href="/admin/searchorder?query=${query}&page=${currentPage - 1}">Previous</a></li>`;
//   }

//   for (let i = 1; i <= totalPages; i++) {
//     if (currentPage === i) {
//       paginationHTML += `<li class="active page-item"><a class="page-link" href="/admin/searchorder?query=${query}&page=${i}">${i}</a></li>`;
//     } else {
//       paginationHTML += `<li class="page-item"><a class="page-link" href="/admin/searchorder?query=${query}&page=${i}">${i}</a></li>`;
//     }
//   }

//   if (currentPage < totalPages) {
//     paginationHTML += `<li class="page-item"><a class="page-link" href="/admin/searchorder?query=${query}&page=${currentPage + 1}">Next</a></li>`;
//   }

//   paginationHTML += `</ul>`;
//   return paginationHTML;
// }



// function replaceButtonsForOrder(orderId) {
//   const tdElement = document.getElementById(`td${orderId}`);
//   if (tdElement) {
//     tdElement.innerHTML = `
//     <input
//                 placeholder="Enter a Reason"
//                 class="input-value"
//                 type="text"
//                 id="returnreason${orderId}"
//                 name="returnreason"
//                 required
//               />
//       <button class="btn btn-danger btns  return-btn"  data-return-id="${orderId}" data-user-id="${orderId}" id=
//       "return${orderId}">
//         Return
//       </button>`;
   
//   }
// }
function replaceButtonsForOrder(orderId) {
  const tdElement = document.getElementById(`td${orderId}`);
  if (tdElement) {
    tdElement.innerHTML = `
      <button type="button" class="btn  btn-danger btns return-btn" data-bs-toggle="modal" data-bs-target="#returnModal${orderId}">
        Return
      </button>

      <!-- Modal -->
      <div class="modal fade" id="returnModal${orderId}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Select a Reason for Return</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="returnReason${orderId}" id="productDefects${orderId}" value=" Product Defects or Damage">
                <label class="form-check-label" for="productDefects${orderId}">
                  Product Defects or Damage
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="returnReason${orderId}" id="changeOfMind${orderId}" value="Change of Mind">
                <label class="form-check-label" for="changeOfMind${orderId}" >
                  Change of Mind
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="returnReason${orderId}" id="sizeFitIssues${orderId}" value="  Size/Fit Issues">
                <label class="form-check-label" for="sizeFitIssues${orderId}">
                  Size/Fit Issues
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="returnReason${orderId}" id="qualityIssues${orderId}" value="Quality Issues">
                <label class="form-check-label" for="qualityIssues${orderId}">
                  Quality Issues
                </label>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" data-return-id="${orderId}" data-bs-dismiss="modal">
                Save changes
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}


function userOrderReturn(){

  document.querySelectorAll(".cance_btn")
 const button = document.querySelector('.btn-danger');

document.querySelectorAll('.cance_btn').forEach((button) => {
  const userId = button.getAttribute('data-user-id');
  fetch(`/user/userorderReturn/${userId}`,{
    method :"GET"
  }).then((response)=>{
    if(response.ok){
     response.json().then(data=>{
      data.newordersArray.forEach((el)=>{
        replaceButtonsForOrder(el);
      })
     })
    }else{
      console.log("error in userorderReturn")
    }
  }
  )
});

}

window.onload = userOrderReturn;

const invoicebtn = document.querySelectorAll(".invoice_btn");
invoicebtn.forEach((btn) => {
  btn.addEventListener("click", function () {
    const orderid = btn.getAttribute("data-invoice-id"); 
    document.getElementById(`span`).textContent ="Downloading"
  fetch(`/user/invoice/${orderid}`,{
    method:"GET",
  }).then((response) => response.blob()) .then((blob) => {
    document.getElementById(`span`).textContent =""
        const blobUrl = URL.createObjectURL(blob);

        
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = blobUrl;
        a.download = "invoice.pdf"; 

        
        document.body.appendChild(a);
        a.click();

    
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
      })
      .catch((error) => {
        console.error("Download Failed:", error);
        alert("Download Failed");
      });
  });
});









document.querySelectorAll('.cance_btn').forEach((button) => {
  button.addEventListener("click", function(event) {
    event.preventDefault();
    document.getElementById(`span`).textContent  ="Order Cancelled"

    const orderId = this.getAttribute('data-order-id');
    if (orderId) {
      console.log("Order ID:", orderId);

      fetch(`/user/userorderCancel/${orderId}`, {
        method: "GET"
      }).then((response) => {
        if (response.ok) {
          response.json().then(data=>{
            document.getElementById(data.order_id).textContent="cancelled"
           setInterval(function(){
            document.getElementById(`span`).textContent=""
           },1000)
          })
          console.log("Success");
        } else {
          console.log("Error");
        }
      });
    } else {
      console.log("No order ID found");
    }
  });
});


document.querySelectorAll('.cance_btn').forEach((button) => {

  
})


// document.body.addEventListener("click", function (event) {
//   if (event.target.classList.contains("return-btn")) {
//     event.preventDefault();
//     const orderId = event.target.getAttribute("data-return-id");
   
//     if (orderId ) {
//       console.log("Order ID:", orderId);
//       const inputValue = document.querySelector(`#returnreason${orderId}`).value.trim();
//       const validCharactersRegex = /^(?=.*[a-zA-Z\s]).*$/;
//     console.log(inputValue)
// if(validCharactersRegex.test(inputValue)){
  
//   fetch(`/user/userReturnProduct/${orderId}`, {
//          method: "POST",
//          headers:{
//           "Content-Type": "application/json"
//          },
//          body:JSON.stringify({inputValue})
//        }).then((response) => {
//          if (response.ok) {
//            response.json().then((data) => {
//              document.getElementById(data.order_id).textContent = "Applied For Return";
//              removeReturnButton(data.order_id);
//              document.querySelector(`#returnreason${data.order_id}`).style.display = "none"
            
//            });
//            console.log("Success returning product");
//          } else {
//            console.log("Error in returning product");
//          }
//        });
// }else{
//   alert("Enter a Reason")
// }
//    } else {
//       console.log("No order ID found");
   
//     }
// }
// });

document.body.addEventListener("click", function (event) {
  if (event.target.classList.contains("btn-primary") && event.target.hasAttribute("data-return-id")) {
    event.preventDefault();
    const orderId = event.target.getAttribute("data-return-id");
    const selectedReason = document.querySelector(`input[name="returnReason${orderId}"]:checked`);
    document.getElementById(`span`).textContent = "Applied For Return"
    if (orderId && selectedReason) {
      console.log("Order ID:", orderId);
      console.log("Selected Reason:", selectedReason.value);

      fetch(`/user/userReturnProduct/${orderId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ reason: selectedReason.value }),
      }).then((response) => {
        if (response.ok) {
          response.json().then((data) => {
            document.getElementById(data.order_id).textContent = "Applied For Return";
            removeReturnButton(data.order_id);
            setInterval(function(){
              document.getElementById(`span`).textContent = ""
            },1000)
          });
          console.log("Success returning product");
        } else {
          console.log("Error in returning product");
        }
      });
    } else {
      console.log("No order ID or selected reason found");
    }
  }
});
function removeReturnButton(orderId) {
  const returnButton = document.getElementById(`return${orderId}`);
  if (returnButton) {
    returnButton.remove();
  }
}


  </script>
 
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
 
  </body>
</html>